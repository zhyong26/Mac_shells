#!/bin/bash

# ==========================================
# 工具名称: pkm-export (修复版)
# ==========================================

PDF_ENGINE="tectonic"
MAIN_FONT="PingFang SC"

# --- 检查依赖 ---
for cmd in pandoc $PDF_ENGINE; do
    if ! command -v $cmd &> /dev/null; then
        echo "❌ 错误: 未安装 $cmd"
        exit 1
    fi
done

if [ "$#" -lt 1 ]; then
    echo "用法: pkm-export <文件名.md> [pdf|doc|all]"
    exit 1
fi

INPUT_FILE="$1"
FORMAT=$(echo "$2" | tr '[:upper:]' '[:lower:]') 
FILENAME="${INPUT_FILE%.*}"

if [ -z "$FORMAT" ]; then
    echo "--- 报告导出工具 ---"
    echo "请选择导出格式: 1) PDF  2) Docx  3) 全部"
    printf "输入 [1-3]: "
    read choice
    case $choice in
        1) FORMAT="pdf" ;;
        2) FORMAT="doc" ;;
        3) FORMAT="all" ;;
        *) exit 1 ;;
    esac
fi

export_pdf() {
    echo "⏳ 正在生成 PDF..."
    
    # 清理非法 UTF-8 字符
    iconv -f UTF-8 -t UTF-8 -c "$INPUT_FILE" > "${INPUT_FILE}.tmp"

    # 关键点：确保每一行末尾都有反斜杠 \ 且后面没有任何空格
    pandoc "${INPUT_FILE}.tmp" \
        --pdf-engine=$PDF_ENGINE \
        -V mainfont="$MAIN_FONT" \
        -V CJKmainfont="$MAIN_FONT" \
        -V geometry:margin=1in \
        -V "header-includes=\\usepackage{xeCJK} \\usepackage{fvextra} \\DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\\\\{\\}}" \
        --toc \
        -o "${FILENAME}.pdf"

    if [ $? -eq 0 ]; then
        echo "✅ PDF 已生成: ${FILENAME}.pdf"
    else
        echo "❌ PDF 生成失败"
    fi
    rm -f "${INPUT_FILE}.tmp"
    # 清理临时文件 (可选)
    rm -f texput.log
}

export_doc() {
    echo "⏳ 正在生成 Docx..."
    pandoc "$INPUT_FILE" -o "${FILENAME}.docx"
    [ $? -eq 0 ] && echo "✅ Docx 已生成: ${FILENAME}.docx"
}

case $FORMAT in
    pdf) export_pdf ;;
    doc|docx) export_doc ;;
    all) export_pdf; export_doc ;;
esac
